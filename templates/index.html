<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🗣️ Bible Speech Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', 'Arial', 'Noto Sans', sans-serif;
        }
        textarea {
            resize: vertical;
        }
        button {
            transition: transform 0.2s, background-color 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        #result {
            white-space: pre-wrap;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4 sm:p-6 md:p-8">
    <div class="bg-white rounded-lg shadow-lg p-6 sm:p-8 w-full max-w-3xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-6">🗣️ Bible Speech Practice</h1>
        <label for="sentenceInput" class="block text-sm sm:text-base font-medium text-gray-700 mb-2">
            Enter a Bible verse in Tamil:
        </label>
        <textarea
            id="sentenceInput"
            placeholder="Type your Bible verse here..."
            class="w-full h-24 sm:h-32 p-4 text-sm sm:text-base border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
        ></textarea>
        <div class="flex flex-wrap justify-center gap-4 mt-6">
            <button
                id="startButton"
                class="bg-green-500 text-white px-6 py-3 rounded-md text-sm sm:text-base font-medium hover:bg-green-600"
            >
                🎤 Start Speaking
            </button>
            <button
                id="retryButton"
                class="bg-blue-500 text-white px-6 py-3 rounded-md text-sm sm:text-base font-medium hover:bg-blue-600 hidden"
            >
                🔁 Retry
            </button>
            <button
                id="clearButton"
                class="bg-red-500 text-white px-6 py-3 rounded-md text-sm sm:text-base font-medium hover:bg-red-600 hidden"
            >
                🧹 Clear Text
            </button>
        </div>
        <div id="transcription" class="mt-6 text-blue-600 text-sm sm:text-base text-center"></div>
        <div id="result" class="mt-4 text-green-700 font-semibold text-sm sm:text-base text-center"></div>
    </div>

    <script>
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'ta-IN';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        const startButton = document.getElementById('startButton');
        const retryButton = document.getElementById('retryButton');
        const clearButton = document.getElementById('clearButton');
        const sentenceInput = document.getElementById('sentenceInput');
        const transcriptionDiv = document.getElementById('transcription');
        const resultDiv = document.getElementById('result');

        function updateTranscription(text) {
            transcriptionDiv.textContent = text;
        }

        function updateResult(text) {
            resultDiv.textContent = text;
        }

        function showRecordingUI(show) {
            document.querySelector('label').style.display = show ? 'block' : 'none';
            sentenceInput.style.display = show ? 'block' : 'none';
        }

        function showRetryUI() {
            retryButton.classList.remove('hidden');
            clearButton.classList.remove('hidden');
        }

        function processSpeech() {
            const sentence = sentenceInput.value.trim();
            if (!sentence) {
                alert('Please enter a sentence.');
                return;
            }

            startButton.classList.add('hidden');
            retryButton.classList.add('hidden');
            clearButton.classList.add('hidden');
            updateTranscription('');
            updateResult('');
            showRecordingUI(false);

            updateTranscription('🎤 Listening... Speak clearly');
            recognition.start();

            recognition.onresult = async (event) => {
                const recognizedText = event.results[0][0].transcript;
                updateTranscription('✅ Finished Listening.');

                try {
                    const response = await fetch('/process_speech', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            expected_sentence: sentence,
                            recognized_text: recognizedText
                        })
                    });

                    const data = await response.json();
                    if (data.error) {
                        updateTranscription(data.transcription);
                    } else {
                        updateTranscription(data.transcription);
                        updateResult(data.result);
                    }
                } catch (error) {
                    updateTranscription(`⚠️ Error: ${error.message}`);
                }

                showRecordingUI(true);
                showRetryUI();
            };

            recognition.onerror = (event) => {
                updateTranscription(`❌ Speech recognition error: ${event.error}`);
                showRecordingUI(true);
                showRetryUI();
            };

            recognition.onend = () => {
                recognition.stop();
            };
        }

        startButton.addEventListener('click', processSpeech);
        retryButton.addEventListener('click', processSpeech);
        clearButton.addEventListener('click', () => {
            sentenceInput.value = '';
            updateTranscription('');
            updateResult('');
            startButton.classList.remove('hidden');
            retryButton.classList.add('hidden');
            clearButton.classList.add('hidden');
        });
    </script>
</body>
</html>